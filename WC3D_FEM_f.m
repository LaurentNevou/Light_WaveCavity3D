function[Ex,Ey,Ez,f0]=WC3D_FEM_f(x,y,z,eps,nmodes,f0_guess,f0_min,f0_max)

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

c=2.99792458e8;

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

Nx=length(x);
Ny=length(y);
Nz=length(z);
Nxyz=Nx*Ny*Nz;

dx=x(2)-x(1);
dy=y(2)-y(1);
dz=z(2)-z(1);

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%% Building of the operators %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%% Second derivative X %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%% DX2(Ny=3,Nx=3,Nz=3); %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%                                                                                                                %
%  -2   0   0 | 1   0   0 | 0   0   0 || 0   0   0 | 0   0   0 | 0   0   0 || 0   0   0 | 0   0   0 | 0   0   0  %
%   0  -2   0 | 0   1   0 | 0   0   0 || 0   0   0 | 0   0   0 | 0   0   0 || 0   0   0 | 0   0   0 | 0   0   0  %
%   0   0  -2 | 0   0   1 | 0   0   0 || 0   0   0 | 0   0   0 | 0   0   0 || 0   0   0 | 0   0   0 | 0   0   0  %
%   -----------------------------------------------------------------------------------------------------------  %
%   1   0   0 |-2   0   0 | 1   0   0 || 0   0   0 | 0   0   0 | 0   0   0 || 0   0   0 | 0   0   0 | 0   0   0  %
%   0   1   0 | 0  -2   0 | 0   1   0 || 0   0   0 | 0   0   0 | 0   0   0 || 0   0   0 | 0   0   0 | 0   0   0  %
%   0   0   1 | 0   0  -2 | 0   0   1 || 0   0   0 | 0   0   0 | 0   0   0 || 0   0   0 | 0   0   0 | 0   0   0  %
%   -----------------------------------------------------------------------------------------------------------  %
%   0   0   0 | 1   0   0 |-2   0   0 || 0   0   0 | 0   0   0 | 0   0   0 || 0   0   0 | 0   0   0 | 0   0   0  %
%   0   0   0 | 0   1   0 | 0  -2   0 || 0   0   0 | 0   0   0 | 0   0   0 || 0   0   0 | 0   0   0 | 0   0   0  %
%   0   0   0 | 0   0   1 | 0   0  -2 || 0   0   0 | 0   0   0 | 0   0   0 || 0   0   0 | 0   0   0 | 0   0   0  %
%   ===========================================================================================================  %
%   0   0   0 | 0   0   0 | 0   0   0 ||-2   0   0 | 1   0   0 | 0   0   0 || 0   0   0 | 0   0   0 | 0   0   0  %
%   0   0   0 | 0   0   0 | 0   0   0 || 0  -2   0 | 0   1   0 | 0   0   0 || 0   0   0 | 0   0   0 | 0   0   0  %
%   0   0   0 | 0   0   0 | 0   0   0 || 0   0  -2 | 0   0   1 | 0   0   0 || 0   0   0 | 0   0   0 | 0   0   0  %
%   -----------------------------------------------------------------------------------------------------------  %
%   0   0   0 | 0   0   0 | 0   0   0 || 1   0   0 |-2   0   0 | 1   0   0 || 0   0   0 | 0   0   0 | 0   0   0  %
%   0   0   0 | 0   0   0 | 0   0   0 || 0   1   0 | 0  -2   0 | 0   1   0 || 0   0   0 | 0   0   0 | 0   0   0  %
%   0   0   0 | 0   0   0 | 0   0   0 || 0   0   1 | 0   0  -2 | 0   0   1 || 0   0   0 | 0   0   0 | 0   0   0  %
%   -----------------------------------------------------------------------------------------------------------  %
%   0   0   0 | 0   0   0 | 0   0   0 || 0   0   0 | 1   0   0 |-2   0   0 || 0   0   0 | 0   0   0 | 0   0   0  %
%   0   0   0 | 0   0   0 | 0   0   0 || 0   0   0 | 0   1   0 | 0  -2   0 || 0   0   0 | 0   0   0 | 0   0   0  %
%   0   0   0 | 0   0   0 | 0   0   0 || 0   0   0 | 0   0   1 | 0   0  -2 || 0   0   0 | 0   0   0 | 0   0   0  %
%   ===========================================================================================================  %
%   0   0   0 | 0   0   0 | 0   0   0 || 0   0   0 | 0   0   0 | 0   0   0 ||-2   0   0 | 1   0   0 | 0   0   0  %
%   0   0   0 | 0   0   0 | 0   0   0 || 0   0   0 | 0   0   0 | 0   0   0 || 0  -2   0 | 0   1   0 | 0   0   0  %
%   0   0   0 | 0   0   0 | 0   0   0 || 0   0   0 | 0   0   0 | 0   0   0 || 0   0  -2 | 0   0   1 | 0   0   0  %
%   -----------------------------------------------------------------------------------------------------------  %
%   0   0   0 | 0   0   0 | 0   0   0 || 0   0   0 | 0   0   0 | 0   0   0 || 1   0   0 |-2   0   0 | 1   0   0  %
%   0   0   0 | 0   0   0 | 0   0   0 || 0   0   0 | 0   0   0 | 0   0   0 || 0   1   0 | 0  -2   0 | 0   1   0  %
%   0   0   0 | 0   0   0 | 0   0   0 || 0   0   0 | 0   0   0 | 0   0   0 || 0   0   1 | 0   0  -2 | 0   0   1  %
%   -----------------------------------------------------------------------------------------------------------  %
%   0   0   0 | 0   0   0 | 0   0   0 || 0   0   0 | 0   0   0 | 0   0   0 || 0   0   0 | 1   0   0 |-2   0   0  %
%   0   0   0 | 0   0   0 | 0   0   0 || 0   0   0 | 0   0   0 | 0   0   0 || 0   0   0 | 0   1   0 | 0  -2   0  %
%   0   0   0 | 0   0   0 | 0   0   0 || 0   0   0 | 0   0   0 | 0   0   0 || 0   0   0 | 0   0   1 | 0   0  -2  %
%                                                                                                                %
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

Axy  = [ ones(1,(Nx-1)*Ny) zeros(1,Ny) ];
Axyz = [ repmat(Axy,1,Nz-1) ones(1,(Nx-1)*Ny) ];

DX1 = (-0.5)*diag(Axyz,-Ny) + (+0.5)*diag(Axyz,Ny);
DX2 = (-2)*diag(ones(1,Nx*Ny*Nz)) + (1)*diag(Axyz,-Ny) + (1)*diag(Axyz,Ny);

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%% Second derivative Y %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%% DY2(Ny=3,Nx=3,Nz=3); %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%                                                                                                                %
%  -2   1   0 | 0   0   0 | 0   0   0 || 0   0   0 | 0   0   0 | 0   0   0 || 0   0   0 | 0   0   0 | 0   0   0  %
%   1  -2   1 | 0   0   0 | 0   0   0 || 0   0   0 | 0   0   0 | 0   0   0 || 0   0   0 | 0   0   0 | 0   0   0  %
%   0   1  -2 | 0   0   0 | 0   0   0 || 0   0   0 | 0   0   0 | 0   0   0 || 0   0   0 | 0   0   0 | 0   0   0  %
%   -----------------------------------------------------------------------------------------------------------  %
%   0   0   0 |-2   1   0 | 0   0   0 || 0   0   0 | 0   0   0 | 0   0   0 || 0   0   0 | 0   0   0 | 0   0   0  %
%   0   0   0 | 1  -2   1 | 0   0   0 || 0   0   0 | 0   0   0 | 0   0   0 || 0   0   0 | 0   0   0 | 0   0   0  %
%   0   0   0 | 0   1  -2 | 0   0   0 || 0   0   0 | 0   0   0 | 0   0   0 || 0   0   0 | 0   0   0 | 0   0   0  %
%   -----------------------------------------------------------------------------------------------------------  %
%   0   0   0 | 0   0   0 |-2   1   0 || 0   0   0 | 0   0   0 | 0   0   0 || 0   0   0 | 0   0   0 | 0   0   0  %
%   0   0   0 | 0   0   0 | 1  -2   1 || 0   0   0 | 0   0   0 | 0   0   0 || 0   0   0 | 0   0   0 | 0   0   0  %
%   0   0   0 | 0   0   0 | 0   1  -2 || 0   0   0 | 0   0   0 | 0   0   0 || 0   0   0 | 0   0   0 | 0   0   0  %
%   ===========================================================================================================  %
%   0   0   0 | 0   0   0 | 0   0   0 ||-2   1   0 | 0   0   0 | 0   0   0 || 0   0   0 | 0   0   0 | 0   0   0  %
%   0   0   0 | 0   0   0 | 0   0   0 || 1  -2   1 | 0   0   0 | 0   0   0 || 0   0   0 | 0   0   0 | 0   0   0  %
%   0   0   0 | 0   0   0 | 0   0   0 || 0   1  -2 | 0   0   0 | 0   0   0 || 0   0   0 | 0   0   0 | 0   0   0  %
%   -----------------------------------------------------------------------------------------------------------  %
%   0   0   0 | 0   0   0 | 0   0   0 || 0   0   0 |-2   1   0 | 0   0   0 || 0   0   0 | 0   0   0 | 0   0   0  %
%   0   0   0 | 0   0   0 | 0   0   0 || 0   0   0 | 1  -2   1 | 0   0   0 || 0   0   0 | 0   0   0 | 0   0   0  %
%   0   0   0 | 0   0   0 | 0   0   0 || 0   0   0 | 0   1  -2 | 0   0   0 || 0   0   0 | 0   0   0 | 0   0   0  %
%   -----------------------------------------------------------------------------------------------------------  %
%   0   0   0 | 0   0   0 | 0   0   0 || 0   0   0 | 0   0   0 |-2   1   0 || 0   0   0 | 0   0   0 | 0   0   0  %
%   0   0   0 | 0   0   0 | 0   0   0 || 0   0   0 | 0   0   0 | 1  -2   1 || 0   0   0 | 0   0   0 | 0   0   0  %
%   0   0   0 | 0   0   0 | 0   0   0 || 0   0   0 | 0   0   0 | 0   1  -2 || 0   0   0 | 0   0   0 | 0   0   0  %
%   ===========================================================================================================  %
%   0   0   0 | 0   0   0 | 0   0   0 || 0   0   0 | 0   0   0 | 0   0   0 ||-2   1   0 | 0   0   0 | 0   0   0  %
%   0   0   0 | 0   0   0 | 0   0   0 || 0   0   0 | 0   0   0 | 0   0   0 || 1  -2   1 | 0   0   0 | 0   0   0  %
%   0   0   0 | 0   0   0 | 0   0   0 || 0   0   0 | 0   0   0 | 0   0   0 || 0   1  -2 | 0   0   0 | 0   0   0  %
%   -----------------------------------------------------------------------------------------------------------  %
%   0   0   0 | 0   0   0 | 0   0   0 || 0   0   0 | 0   0   0 | 0   0   0 || 0   0   0 |-2   1   0 | 0   0   0  %
%   0   0   0 | 0   0   0 | 0   0   0 || 0   0   0 | 0   0   0 | 0   0   0 || 0   0   0 | 1  -2   1 | 0   0   0  %
%   0   0   0 | 0   0   0 | 0   0   0 || 0   0   0 | 0   0   0 | 0   0   0 || 0   0   0 | 0   1  -2 | 0   0   0  %
%   -----------------------------------------------------------------------------------------------------------  %
%   0   0   0 | 0   0   0 | 0   0   0 || 0   0   0 | 0   0   0 | 0   0   0 || 0   0   0 | 0   0   0 |-2   1   0  %
%   0   0   0 | 0   0   0 | 0   0   0 || 0   0   0 | 0   0   0 | 0   0   0 || 0   0   0 | 0   0   0 | 1  -2   1  %
%   0   0   0 | 0   0   0 | 0   0   0 || 0   0   0 | 0   0   0 | 0   0   0 || 0   0   0 | 0   0   0 | 0   1  -2  %
%                                                                                                                %
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

BB=ones(1,Nx*Ny*Nz-1);
BB(Ny:Ny:end)=0;

DY1 = (-0.5)*diag(BB,-1) + (+0.5)*diag(BB,1);
DY2 = (-2)*diag(ones(1,Nx*Ny*Nz)) + (1)*diag(BB,-1) + (1)*diag(BB,1);

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%% Second derivative Z %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%% DZ2(Ny=3,Nx=3,Nz=3); %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%                                                                                                                %
%  -2   0   0 | 0   0   0 | 0   0   0 || 1   0   0 | 0   0   0 | 0   0   0 || 0   0   0 | 0   0   0 | 0   0   0  %
%   0  -2   0 | 0   0   0 | 0   0   0 || 0   1   0 | 0   0   0 | 0   0   0 || 0   0   0 | 0   0   0 | 0   0   0  %
%   0   0  -2 | 0   0   0 | 0   0   0 || 0   0   1 | 0   0   0 | 0   0   0 || 0   0   0 | 0   0   0 | 0   0   0  %
%   -----------------------------------------------------------------------------------------------------------  %
%   0   0   0 |-2   0   0 | 0   0   0 || 0   0   0 | 1   0   0 | 0   0   0 || 0   0   0 | 0   0   0 | 0   0   0  %
%   0   0   0 | 0  -2   0 | 0   0   0 || 0   0   0 | 0   1   0 | 0   0   0 || 0   0   0 | 0   0   0 | 0   0   0  %
%   0   0   0 | 0   0  -2 | 0   0   0 || 0   0   0 | 0   0   1 | 0   0   0 || 0   0   0 | 0   0   0 | 0   0   0  %
%   -----------------------------------------------------------------------------------------------------------  %
%   0   0   0 | 0   0   0 |-2   0   0 || 0   0   0 | 0   0   0 | 1   0   0 || 0   0   0 | 0   0   0 | 0   0   0  %
%   0   0   0 | 0   0   0 | 0  -2   0 || 0   0   0 | 0   0   0 | 0   1   0 || 0   0   0 | 0   0   0 | 0   0   0  %
%   0   0   0 | 0   0   0 | 0   0  -2 || 0   0   0 | 0   0   0 | 0   0   1 || 0   0   0 | 0   0   0 | 0   0   0  %
%   ===========================================================================================================  %
%   1   0   0 | 0   0   0 | 0   0   0 ||-2   0   0 | 0   0   0 | 0   0   0 || 1   0   0 | 0   0   0 | 0   0   0  %
%   0   1   0 | 0   0   0 | 0   0   0 || 0  -2   0 | 0   0   0 | 0   0   0 || 0   1   0 | 0   0   0 | 0   0   0  %
%   0   0   1 | 0   0   0 | 0   0   0 || 0   0  -2 | 0   0   0 | 0   0   0 || 0   0   1 | 0   0   0 | 0   0   0  %
%   -----------------------------------------------------------------------------------------------------------  %
%   0   0   0 | 1   0   0 | 0   0   0 || 0   0   0 |-2   0   0 | 0   0   0 || 0   0   0 | 1   0   0 | 0   0   0  %
%   0   0   0 | 0   1   0 | 0   0   0 || 0   0   0 | 0  -2   0 | 0   0   0 || 0   0   0 | 0   1   0 | 0   0   0  %
%   0   0   0 | 0   0   1 | 0   0   0 || 0   0   0 | 0   0  -2 | 0   0   0 || 0   0   0 | 0   0   1 | 0   0   0  %
%   -----------------------------------------------------------------------------------------------------------  %
%   0   0   0 | 0   0   0 | 1   0   0 || 0   0   0 | 0   0   0 |-2   0   0 || 0   0   0 | 0   0   0 | 1   0   0  %
%   0   0   0 | 0   0   0 | 0   1   0 || 0   0   0 | 0   0   0 | 0  -2   0 || 0   0   0 | 0   0   0 | 0   1   0  %
%   0   0   0 | 0   0   0 | 0   0   1 || 0   0   0 | 0   0   0 | 0   0  -2 || 0   0   0 | 0   0   0 | 0   0   1  %
%   ===========================================================================================================  %
%   0   0   0 | 0   0   0 | 0   0   0 || 1   0   0 | 0   0   0 | 0   0   0 ||-2   0   0 | 0   0   0 | 0   0   0  %
%   0   0   0 | 0   0   0 | 0   0   0 || 0   1   0 | 0   0   0 | 0   0   0 || 0  -2   0 | 0   0   0 | 0   0   0  %
%   0   0   0 | 0   0   0 | 0   0   0 || 0   0   1 | 0   0   0 | 0   0   0 || 0   0  -2 | 0   0   0 | 0   0   0  %
%   -----------------------------------------------------------------------------------------------------------  %
%   0   0   0 | 0   0   0 | 0   0   0 || 0   0   0 | 1   0   0 | 0   0   0 || 0   0   0 |-2   0   0 | 0   0   0  %
%   0   0   0 | 0   0   0 | 0   0   0 || 0   0   0 | 0   1   0 | 0   0   0 || 0   0   0 | 0  -2   0 | 0   0   0  %
%   0   0   0 | 0   0   0 | 0   0   0 || 0   0   0 | 0   0   1 | 0   0   0 || 0   0   0 | 0   0  -2 | 0   0   0  %
%   -----------------------------------------------------------------------------------------------------------  %
%   0   0   0 | 0   0   0 | 0   0   0 || 0   0   0 | 0   0   0 | 1   0   0 || 0   0   0 | 0   0   0 |-2   0   0  %
%   0   0   0 | 0   0   0 | 0   0   0 || 0   0   0 | 0   0   0 | 0   1   0 || 0   0   0 | 0   0   0 | 0  -2   0  %
%   0   0   0 | 0   0   0 | 0   0   0 || 0   0   0 | 0   0   0 | 0   0   1 || 0   0   0 | 0   0   0 | 0   0  -2  %
%                                                                                                                %
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%


Axyz=ones(1,Nx*Ny*(Nz-1));

DZ1 = (-0.5)*diag(Axyz,-Nx*Ny) + (+0.5)*diag(Axyz,Nx*Ny);
DZ2 = (-2)*diag(ones(1,Nx*Ny*Nz)) + (1)*diag(Axyz,-Nx*Ny) + (1)*diag(Axyz,Nx*Ny);

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%% Building of the Hamiltonien %%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

H0 = DX2/dx^2 + DY2/dy^2 + DZ2/dz^2 ;

H11 =  H0 +  DX1/dx * diag(1./eps(:)) * diag(  DX1/dx * eps(:)  )  ;
H11 = -diag(1./eps(:)) * H11;

H22 =  H0 +  DY1/dy * diag(1./eps(:)) * diag(  DY1/dy * eps(:)  )  ;
H22 = -diag(1./eps(:)) * H22;

H33 =  H0 +  DZ1/dz * diag(1./eps(:)) * diag(  DZ1/dz * eps(:)  )  ;
H33 = -diag(1./eps(:)) * H33;


H12 =       DX1/dx * diag(1./eps(:)) * diag(  DY1/dy * eps(:)  )  ;
H12 = -diag(1./eps(:)) * H12;

H13 =       DX1/dx * diag(1./eps(:)) * diag(  DZ1/dz * eps(:)  )  ;
H13 = -diag(1./eps(:)) * H13;


H21 =       DY1/dy * diag(1./eps(:)) * diag(  DX1/dx * eps(:)  )  ;
H21 = -diag(1./eps(:)) * H21;

H23 =       DY1/dy * diag(1./eps(:)) * diag(  DZ1/dz * eps(:)  )  ;
H23 = -diag(1./eps(:)) * H23;


H31 =       DZ1/dz * diag(1./eps(:)) * diag(  DX1/dx * eps(:)  )  ;
H31 = -diag(1./eps(:)) * H31;

H32 =       DZ1/dz * diag(1./eps(:)) * diag(  DY1/dy * eps(:)  )  ;
H32 = -diag(1./eps(:)) * H32;

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

H = [ 
H11 H12 H13
H21 H22 H23 
H31 H32 H33 ] ;

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%% Diagonalisation of the Hamiltonien %%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

Guess = (2*pi*f0_guess/c)^2;

H=sparse(H);
[psi,k0] = eigs(H,nmodes,'SM');   %% eigen values are ordered
%[psi,k0] = eigs(H,nmodes,Guess);

f0=sqrt(diag(k0)) * c /2/pi;
lambda= 2*pi ./ sqrt(diag(k0)) * 1e6;

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%% Filtering and reshaping the Wavefunction %%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

idx1=real(f0)>f0_min;
idx2=real(f0)<f0_max;
idx3=imag(f0)==0;
idx=logical( idx1.*idx2.*idx3);

f0=f0(idx);
psi=psi(:,idx);
%f0=f0(end:-1:1,:);         % in Octave, the eigen solution are reversed
%psi=psi(:,end:-1:1);       % in Octave, the eigen solution are reversed

nmodes=length(f0);

Ex = psi( 1:Nxyz        , : );
Ey = psi( Nxyz+1:2*Nxyz , : );
Ez = psi( 2*Nxyz+1:end  , : );

Ex = reshape(Ex,[Ny,Nx,Nz,nmodes]);
Ey = reshape(Ey,[Ny,Nx,Nz,nmodes]);
Ez = reshape(Ez,[Ny,Nx,Nz,nmodes]);

end
